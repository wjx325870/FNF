name: Process FNF Audio

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

jobs:
  separate-audio:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. å‡†å¤‡ç¯å¢ƒ
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 2. å®‰è£…æ‰€æœ‰å¿…éœ€çš„ä¾èµ–åŒ…ï¼ˆå…³é”®ï¼šä¸€æ¬¡æ€§å…¨éƒ¨å®‰è£…ï¼‰
      - name: å®‰è£…æ‰€æœ‰éŸ³é¢‘å¤„ç†ä¾èµ–
        run: |
          # æ›´æ–°pipå¹¶å®‰è£…æ ¸å¿ƒåŒ…
          pip install --upgrade pip
          # Demucsæ ¸å¿ƒåŠå…¶æ‰€æœ‰è¾…åŠ©åº“
          pip install demucs
          pip install diffq                     # è§£å†³ä¹‹å‰DiffQé”™è¯¯
          pip install torchcodec                # è§£å†³å½“å‰torchcodecé”™è¯¯
          # ç¡®ä¿éŸ³é¢‘æ–‡ä»¶è¯»å†™æ”¯æŒçš„åº“
          pip install librosa soundfile
          # å¯é€‰ï¼šç¡®ä¿torchaudioç¨³å®šï¼Œé¿å…è§£ç é—®é¢˜
          pip install --upgrade torchaudio
          # å®‰è£…ç³»ç»Ÿçº§çš„FFmpegç”¨äºéŸ³é¢‘è½¬æ¢
          sudo apt-get update && sudo apt-get install -y ffmpeg
          echo "âœ… æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæˆã€‚"

      # 3. æ‰§è¡Œäººå£°åˆ†ç¦»
      - name: åˆ†ç¦»äººå£°ä¸ä¼´å¥
        id: separate
        run: |
          echo "æ­£åœ¨æŸ¥æ‰¾éŸ³é¢‘æ–‡ä»¶..."
          # æ”¯æŒæ‰€æœ‰å¸¸è§éŸ³é¢‘æ ¼å¼
          INPUT_FILE=$(find ./raw_audio -type f \( -iname "*.mp3" -o -iname "*.wav" -o -iname "*.flac" -o -iname "*.ogg" -o -iname "*.m4a" \) | head -n 1)
          if [ -z "$INPUT_FILE" ]; then
            echo "âŒ é”™è¯¯ï¼šåœ¨ 'raw_audio/' ç›®å½•ä¸­æœªæ‰¾åˆ°æ”¯æŒçš„éŸ³é¢‘æ–‡ä»¶ã€‚"
            echo "è¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼ä¸º .mp3, .wav, .flac, .ogg æˆ– .m4aã€‚"
            exit 1
          fi
          echo "å¼€å§‹å¤„ç†æ–‡ä»¶: $INPUT_FILE"

          # ä½¿ç”¨Demucsè¿›è¡Œåˆ†ç¦»ï¼Œæ¨¡å‹ä¸º mdx_q
          echo "æ­£åœ¨å¯åŠ¨AIåˆ†ç¦»è¿›ç¨‹ï¼Œè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ..."
          python -m demucs.separate -n mdx_q --two-stems=vocals -o ./separated "$INPUT_FILE"

          # éªŒè¯è¾“å‡ºè·¯å¾„
          MODEL_OUT_DIR="./separated/mdx_q"
          if [ -d "$MODEL_OUT_DIR" ]; then
            SONG_DIR=$(find "$MODEL_OUT_DIR" -maxdepth 1 -type d ! -path "$MODEL_OUT_DIR" | head -n 1)
            if [ -n "$SONG_DIR" ]; then
              echo "âœ… åˆ†ç¦»æˆåŠŸï¼æ–‡ä»¶ä½äº: $SONG_DIR"
              echo "song_dir=$SONG_DIR" >> $GITHUB_OUTPUT
            else
              echo "âŒ é”™è¯¯ï¼šåœ¨æ¨¡å‹è¾“å‡ºç›®å½•ä¸­æœªæ‰¾åˆ°æ­Œæ›²å­ç›®å½•ã€‚"
              exit 1
            fi
          else
            echo "âŒ é”™è¯¯ï¼šæ¨¡å‹è¾“å‡ºç›®å½• '$MODEL_OUT_DIR' æœªç”Ÿæˆï¼Œåˆ†ç¦»è¿‡ç¨‹å¯èƒ½å¤±è´¥ã€‚"
            exit 1
          fi

      # 4. è½¬æ¢ä¸ºFNFæ ‡å‡†OGGæ ¼å¼
      - name: è½¬æ¢ä¸ºOGGæ ¼å¼
        run: |
          SONG_DIR="${{ steps.separate.outputs.song_dir }}"
          echo "æ­£åœ¨è½¬æ¢ç›®å½•ä¸­çš„æ–‡ä»¶: $SONG_DIR"

          # è½¬æ¢ä¼´å¥è½¨ (other.wav -> Inst.ogg)
          if [ -f "$SONG_DIR/other.wav" ]; then
            ffmpeg -i "$SONG_DIR/other.wav" -c:a libvorbis -q:a 6 "Inst.ogg" -y -hide_banner -loglevel error
            echo "âœ… å·²ç”Ÿæˆ Inst.ogg (ä¼´å¥)"
          else
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°ä¼´å¥æ–‡ä»¶ 'other.wav'ã€‚"
            exit 1
          fi

          # è½¬æ¢äººå£°è½¨ (vocals.wav -> Voices.ogg)
          if [ -f "$SONG_DIR/vocals.wav" ]; then
            ffmpeg -i "$SONG_DIR/vocals.wav" -c:a libvorbis -q:a 6 "Voices.ogg" -y -hide_banner -loglevel error
            echo "âœ… å·²ç”Ÿæˆ Voices.ogg (äººå£°)"
          else
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°äººå£°æ–‡ä»¶ 'vocals.wav'ã€‚"
            exit 1
          fi

      # 5. æ‰“åŒ…ç»“æœ
      - name: æ‰“åŒ…éŸ³é¢‘æ–‡ä»¶
        run: |
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨å¹¶æ‰“åŒ…
          if [ -f "Inst.ogg" ] && [ -f "Voices.ogg" ]; then
            zip -j fnf_audio_output.zip Inst.ogg Voices.ogg
            echo "âœ… å·²åˆ›å»ºå‹ç¼©åŒ…: fnf_audio_output.zip"
          else
            echo "âŒ é”™è¯¯ï¼šæ— æ³•æ‰¾åˆ°è¦æ‰“åŒ…çš„.oggæ–‡ä»¶ã€‚"
            exit 1
          fi

      # 6. ä¸Šä¼ äº§ç‰©
      - name: ä¸Šä¼ æˆå“
        uses: actions/upload-artifact@v4
        with:
          name: FNF-Audio-Output
          path: fnf_audio_output.zip
          if-no-files-found: error
          retention-days: 7

      # 7. å®Œæˆæç¤º
      - name: å®Œæˆé€šçŸ¥
        run: |
          echo ""
          echo "ğŸ‰ğŸ‰ğŸ‰ éŸ³é¢‘å¤„ç†å…¨éƒ¨å®Œæˆï¼"
          echo "========================================"
          echo "è¯·åœ¨å³ä¾§çš„ 'Artifacts' åŒºåŸŸä¸‹è½½ 'FNF-Audio-Output.zip'ã€‚"
          echo "è¯¥å‹ç¼©åŒ…å†…åŒ…å«:"
          echo "  â€¢ Inst.ogg    (çº¯å‡€ä¼´å¥)"
          echo "  â€¢ Voices.ogg  (åˆ†ç¦»çš„äººå£°)"
          echo "========================================"
          echo "å®ƒä»¬å·²å¯ç›´æ¥å¤åˆ¶åˆ°ä½ çš„ Psych Engine æ¨¡ç»„ä¸­ä½¿ç”¨ã€‚"
