name: Process FNF Audio

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

jobs:
  separate-audio:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. å‡†å¤‡ç¯å¢ƒ
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 2. å®‰è£…æ‰€æœ‰å¿…éœ€ä¾èµ–ï¼ˆå…³é”®ä¿®å¤ç‚¹ï¼‰
      - name: å®‰è£…éŸ³é¢‘å¤„ç†ä¾èµ–
        run: |
          pip install demucs diffq # å¿…é¡»åŒæ—¶å®‰è£… demucs å’Œ diffq
          sudo apt-get update && sudo apt-get install -y ffmpeg

      # 3. æ‰§è¡Œäººå£°åˆ†ç¦» (Demucs)
      - name: åˆ†ç¦»äººå£°ä¸ä¼´å¥
        id: separate
        run: |
          echo "æ­£åœ¨æŸ¥æ‰¾éŸ³é¢‘æ–‡ä»¶..."
          # æ”¯æŒ .mp3, .wav, .flac, .ogg æ ¼å¼
          INPUT_FILE=$(find ./raw_audio -type f \( -iname "*.mp3" -o -iname "*.wav" -o -iname "*.flac" -o -iname "*.ogg" \) | head -n 1)
          if [ -z "$INPUT_FILE" ]; then
            echo "é”™è¯¯ï¼šåœ¨ 'raw_audio/' ç›®å½•ä¸­æœªæ‰¾åˆ°æ”¯æŒçš„éŸ³é¢‘æ–‡ä»¶ (.mp3, .wav, .flac, .ogg)ã€‚"
            exit 1
          fi
          echo "å¼€å§‹å¤„ç†æ–‡ä»¶: $INPUT_FILE"

          # ä½¿ç”¨Demucsè¿›è¡Œåˆ†ç¦»ï¼Œè¾“å‡ºåˆ° ./separated ç›®å½•
          python -m demucs.separate -n mdx_q --two-stems=vocals -o ./separated "$INPUT_FILE"

          # éªŒè¯è¾“å‡ºè·¯å¾„ï¼Œä¾›ä¸‹ä¸€æ­¥ä½¿ç”¨
          MODEL_OUT_DIR="./separated/mdx_q"
          if [ -d "$MODEL_OUT_DIR" ]; then
            SONG_DIR=$(find "$MODEL_OUT_DIR" -maxdepth 1 -type d ! -path "$MODEL_OUT_DIR" | head -n 1)
            if [ -n "$SONG_DIR" ]; then
              echo "åˆ†ç¦»æˆåŠŸï¼æ–‡ä»¶ä½äº: $SONG_DIR"
              echo "song_dir=$SONG_DIR" >> $GITHUB_OUTPUT # è®¾ç½®è¾“å‡ºå˜é‡
            else
              echo "é”™è¯¯ï¼šåœ¨æ¨¡å‹è¾“å‡ºç›®å½•ä¸­æœªæ‰¾åˆ°æ­Œæ›²å­ç›®å½•ã€‚"
              exit 1
            fi
          else
            echo "é”™è¯¯ï¼šæ¨¡å‹è¾“å‡ºç›®å½• '$MODEL_OUT_DIR' æœªç”Ÿæˆã€‚"
            exit 1
          fi

      # 4. è½¬æ¢ä¸ºFNFæ ‡å‡†æ ¼å¼ (.ogg)
      - name: è½¬æ¢ä¸ºOGGæ ¼å¼
        run: |
          SONG_DIR="${{ steps.separate.outputs.song_dir }}"
          echo "æ­£åœ¨è½¬æ¢ç›®å½•ä¸­çš„æ–‡ä»¶: $SONG_DIR"

          # è½¬æ¢ä¼´å¥è½¨ (other.wav -> Inst.ogg)
          if [ -f "$SONG_DIR/other.wav" ]; then
            ffmpeg -i "$SONG_DIR/other.wav" -c:a libvorbis -q:a 6 "Inst.ogg" -y -hide_banner -loglevel error
            echo "âœ… å·²ç”Ÿæˆ Inst.ogg (ä¼´å¥)"
          else
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°ä¼´å¥æ–‡ä»¶ 'other.wav'ã€‚"
            exit 1
          fi

          # è½¬æ¢äººå£°è½¨ (vocals.wav -> Voices.ogg)
          if [ -f "$SONG_DIR/vocals.wav" ]; then
            ffmpeg -i "$SONG_DIR/vocals.wav" -c:a libvorbis -q:a 6 "Voices.ogg" -y -hide_banner -loglevel error
            echo "âœ… å·²ç”Ÿæˆ Voices.ogg (äººå£°)"
          else
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°äººå£°æ–‡ä»¶ 'vocals.wav'ã€‚"
            exit 1
          fi

      # 5. æ‰“åŒ…ç»“æœ
      - name: æ‰“åŒ…éŸ³é¢‘æ–‡ä»¶
        run: |
          zip -j fnf_audio_output.zip Inst.ogg Voices.ogg
          echo "å·²åˆ›å»ºå‹ç¼©åŒ…: fnf_audio_output.zip"

      # 6. ä¸Šä¼ äº§ç‰©
      - name: ä¸Šä¼ æˆå“
        uses: actions/upload-artifact@v4
        with:
          name: FNF-Audio-Output
          path: fnf_audio_output.zip
          if-no-files-found: error

      # 7. å®Œæˆæç¤º
      - name: å®Œæˆé€šçŸ¥
        run: |
          echo "ğŸ‰ éŸ³é¢‘å¤„ç†å…¨éƒ¨å®Œæˆï¼"
          echo "è¯·åœ¨å³ä¾§çš„ 'Artifacts' åŒºåŸŸä¸‹è½½ 'FNF-Audio-Output.zip'ã€‚"
          echo "è¯¥å‹ç¼©åŒ…å†…åŒ…å« 'Inst.ogg' å’Œ 'Voices.ogg'ï¼Œå¯ç›´æ¥ç”¨äº Psych Engine æ¨¡ç»„ã€‚"
