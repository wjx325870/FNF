name: Process FNF Audio

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

jobs:
  separate-audio:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. å‡†å¤‡ç¯å¢ƒ
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 2. å®‰è£…æ‰€æœ‰å¿…éœ€çš„ä¾èµ–åŒ…
      - name: å®‰è£…æ‰€æœ‰éŸ³é¢‘å¤„ç†ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install demucs diffq torchcodec librosa soundfile
          pip install --upgrade torchaudio
          sudo apt-get update && sudo apt-get install -y ffmpeg
          echo "âœ… æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæˆã€‚"

      # 3. æ‰§è¡Œäººå£°åˆ†ç¦» (å…³é”®æ­¥éª¤)
      - name: åˆ†ç¦»äººå£°ä¸ä¼´å¥
        id: separate
        run: |
          echo "æ­£åœ¨æŸ¥æ‰¾éŸ³é¢‘æ–‡ä»¶..."
          INPUT_FILE=$(find ./raw_audio -type f \( -iname "*.mp3" -o -iname "*.wav" -o -iname "*.flac" -o -iname "*.ogg" -o -iname "*.m4a" \) | head -n 1)
          if [ -z "$INPUT_FILE" ]; then
            echo "âŒ é”™è¯¯ï¼šåœ¨ 'raw_audio/' ç›®å½•ä¸­æœªæ‰¾åˆ°æ”¯æŒçš„éŸ³é¢‘æ–‡ä»¶ã€‚"
            exit 1
          fi
          echo "å¼€å§‹å¤„ç†æ–‡ä»¶: $INPUT_FILE"

          # ä½¿ç”¨Demucsè¿›è¡Œåˆ†ç¦»
          echo "æ­£åœ¨å¯åŠ¨AIåˆ†ç¦»è¿›ç¨‹ï¼Œè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ..."
          python -m demucs.separate -n mdx_q --two-stems=vocals -o ./separated "$INPUT_FILE"

          # éªŒè¯è¾“å‡ºè·¯å¾„
          MODEL_OUT_DIR="./separated/mdx_q"
          if [ -d "$MODEL_OUT_DIR" ]; then
            SONG_DIR=$(find "$MODEL_OUT_DIR" -maxdepth 1 -type d ! -path "$MODEL_OUT_DIR" | head -n 1)
            if [ -n "$SONG_DIR" ]; then
              echo "âœ… åˆ†ç¦»æˆåŠŸï¼æ–‡ä»¶ä½äº: $SONG_DIR"
              # ã€å…³é”®è¯Šæ–­ã€‘åˆ—å‡ºç”Ÿæˆçš„æ‰€æœ‰æ–‡ä»¶ï¼Œä¾›åç»­æ­¥éª¤å‚è€ƒ
              echo "è¯Šæ–­ä¿¡æ¯ï¼šç”Ÿæˆç›®å½•å†…çš„æ–‡ä»¶åˆ—è¡¨å¦‚ä¸‹ï¼š"
              ls -la "$SONG_DIR/"
              echo "song_dir=$SONG_DIR" >> $GITHUB_OUTPUT
            else
              echo "âŒ é”™è¯¯ï¼šåœ¨æ¨¡å‹è¾“å‡ºç›®å½•ä¸­æœªæ‰¾åˆ°æ­Œæ›²å­ç›®å½•ã€‚"
              exit 1
            fi
          else
            echo "âŒ é”™è¯¯ï¼šæ¨¡å‹è¾“å‡ºç›®å½• '$MODEL_OUT_DIR' æœªç”Ÿæˆã€‚"
            exit 1
          fi

      # 4. æ™ºèƒ½è½¬æ¢OGGæ ¼å¼ (æ ¸å¿ƒä¿®å¤é€»è¾‘)
      - name: æ™ºèƒ½è½¬æ¢ä¸é‡å‘½å
        run: |
          SONG_DIR="${{ steps.separate.outputs.song_dir }}"
          echo "æ­£åœ¨ä»ç›®å½•æ™ºèƒ½æŸ¥æ‰¾æ–‡ä»¶ï¼š $SONG_DIR"

          # åˆå§‹åŒ–å˜é‡
          INSTRUMENTAL_FILE=""
          VOCALS_FILE=""

          # éå†ç›®å½•ä¸‹æ‰€æœ‰.wavæ–‡ä»¶
          for file in "$SONG_DIR"/*.wav; do
            FILENAME=$(basename "$file")
            echo "æ£€æŸ¥æ–‡ä»¶: $FILENAME"

            # è§„åˆ™1ï¼šé€šè¿‡æ–‡ä»¶åå…³é”®è¯è¯†åˆ«
            case "$FILENAME" in
              *vocals*|*Vocals*|*voice*|*Voice*)
                if [ -z "$VOCALS_FILE" ]; then
                  VOCALS_FILE="$file"
                  echo "  -> è¯†åˆ«ä¸ºäººå£°æ–‡ä»¶"
                fi
                ;;
              *other*|*Other*|*instrumental*|*Instrumental*|*accompaniment*|*no_vocals*)
                if [ -z "$INSTRUMENTAL_FILE" ]; then
                  INSTRUMENTAL_FILE="$file"
                  echo "  -> è¯†åˆ«ä¸ºä¼´å¥æ–‡ä»¶"
                fi
                ;;
              *)
                # æœªåŒ¹é…å…³é”®è¯çš„æ–‡ä»¶ï¼Œæš‚æ—¶è·³è¿‡
                ;;
            esac
          done

          # è§„åˆ™2ï¼šå¦‚æœæœªé€šè¿‡å…³é”®è¯æ‰¾åˆ°ï¼Œä½¿ç”¨å¤‡ç”¨é€»è¾‘
          # å¤‡ç”¨é€»è¾‘ï¼šå‡è®¾ç¬¬ä¸€ä¸ªä¸æ˜¯äººå£°çš„æ–‡ä»¶æ˜¯ä¼´å¥
          if [ -z "$INSTRUMENTAL_FILE" ]; then
            for file in "$SONG_DIR"/*.wav; do
              FILENAME=$(basename "$file")
              if [[ "$FILENAME" != *"vocals"* ]] && [[ "$FILENAME" != *"Vocals"* ]] && [[ "$FILENAME" != *"voice"* ]] && [[ "$FILENAME" != *"Voice"* ]]; then
                INSTRUMENTAL_FILE="$file"
                echo "é€šè¿‡å¤‡ç”¨é€»è¾‘é€‰æ‹©ä¼´å¥æ–‡ä»¶: $FILENAME"
                break
              fi
            done
          fi

          # è§„åˆ™3ï¼šå¦‚æœä»æœªæ‰¾åˆ°ï¼Œåˆ™é€‰æ‹©ç¬¬ä¸€ä¸ª.wavæ–‡ä»¶ä½œä¸ºä¼´å¥
          if [ -z "$INSTRUMENTAL_FILE" ]; then
            INSTRUMENTAL_FILE=$(find "$SONG_DIR" -name "*.wav" | head -n 1)
            echo "é€šè¿‡æœ€ç»ˆå¤‡ç”¨é€»è¾‘é€‰æ‹©ä¼´å¥æ–‡ä»¶: $(basename "$INSTRUMENTAL_FILE")"
          fi

          # è½¬æ¢ä¼´å¥æ–‡ä»¶ (å¿…é¡»å­˜åœ¨)
          if [ -n "$INSTRUMENTAL_FILE" ] && [ -f "$INSTRUMENTAL_FILE" ]; then
            echo "æ­£åœ¨è½¬æ¢ä¼´å¥: $(basename "$INSTRUMENTAL_FILE") -> Inst.ogg"
            ffmpeg -i "$INSTRUMENTAL_FILE" -c:a libvorbis -q:a 6 "Inst.ogg" -y -hide_banner -loglevel error
            echo "âœ… å·²ç”Ÿæˆ Inst.ogg"
          else
            echo "âŒ è‡´å‘½é”™è¯¯ï¼šæ— æ³•å®šä½æˆ–è®¿é—®ä¼´å¥æ–‡ä»¶ã€‚"
            exit 1
          fi

          # è½¬æ¢äººå£°æ–‡ä»¶ (å¦‚æœå­˜åœ¨)
          if [ -n "$VOCALS_FILE" ] && [ -f "$VOCALS_FILE" ]; then
            echo "æ­£åœ¨è½¬æ¢äººå£°: $(basename "$VOCALS_FILE") -> Voices.ogg"
            ffmpeg -i "$VOCALS_FILE" -c:a libvorbis -q:a 6 "Voices.ogg" -y -hide_banner -loglevel error
            echo "âœ… å·²ç”Ÿæˆ Voices.ogg"
          else
            echo "âš ï¸ è­¦å‘Šï¼šæœªæ‰¾åˆ°äººå£°æ–‡ä»¶ï¼Œå°†ç”Ÿæˆé™éŸ³äººå£°è½¨ï¼ˆå ä½ç¬¦ï¼‰ã€‚"
            ffmpeg -f lavfi -i anullsrc=r=44100:cl=stereo -t 3 -c:a libvorbis -q:a 6 "Voices.ogg" -y
            echo "âœ… å·²ç”Ÿæˆé™éŸ³ Voices.ogg (å ä½ç¬¦)"
          fi

      # 5. æ‰“åŒ…ç»“æœ
      - name: æ‰“åŒ…éŸ³é¢‘æ–‡ä»¶
        run: |
          if [ -f "Inst.ogg" ] && [ -f "Voices.ogg" ]; then
            zip -j fnf_audio_output.zip Inst.ogg Voices.ogg
            echo "âœ… å·²åˆ›å»ºå‹ç¼©åŒ…: fnf_audio_output.zip"
          else
            echo "âŒ é”™è¯¯ï¼šæ— æ³•æ‰¾åˆ°è¦æ‰“åŒ…çš„.oggæ–‡ä»¶ã€‚"
            exit 1
          fi

      # 6. ä¸Šä¼ äº§ç‰©
      - name: ä¸Šä¼ æˆå“
        uses: actions/upload-artifact@v4
        with:
          name: FNF-Audio-Output
          path: fnf_audio_output.zip
          if-no-files-found: error
          retention-days: 7

      # 7. å®Œæˆæç¤º
      - name: å®Œæˆé€šçŸ¥
        run: |
          echo ""
          echo "ğŸ‰ğŸ‰ğŸ‰ FNF éŸ³é¢‘å¤„ç†å…¨éƒ¨å®Œæˆï¼"
          echo "========================================"
          echo "è¯·åœ¨å³ä¾§çš„ 'Artifacts' åŒºåŸŸä¸‹è½½ 'FNF-Audio-Output.zip'ã€‚"
          echo "è¯¥å‹ç¼©åŒ…å†…åŒ…å«å¯ç›´æ¥ç”¨äº Psych Engine æ¨¡ç»„çš„æ–‡ä»¶ï¼š"
          echo "  â€¢ Inst.ogg    (ä¼´å¥è½¨é“)"
          echo "  â€¢ Voices.ogg  (äººå£°è½¨é“æˆ–é™éŸ³å ä½ç¬¦)"
          echo "========================================"
