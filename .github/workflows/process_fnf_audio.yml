name: Process FNF Audio

on:
  # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:

jobs:
  separate-audio:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡ç¯å¢ƒå’Œä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # ç¬¬äºŒæ­¥ï¼šå®‰è£…æ ¸å¿ƒä¾èµ–ï¼ˆå…³é”®ä¿®æ­£ï¼‰
      - name: Install Demucs & FFmpeg
        run: |
          pip install demucs
          sudo apt-get update && sudo apt-get install -y ffmpeg

      # ç¬¬ä¸‰æ­¥ï¼šè¿›è¡Œäººå£°åˆ†ç¦»
      - name: Separate Vocals (Demucs)
        id: separate
        run: |
          echo "Looking for audio files..."

          # æŸ¥æ‰¾ raw_audio ç›®å½•ä¸‹çš„éŸ³é¢‘æ–‡ä»¶
          INPUT_FILE=$(find ./raw_audio -type f \( -iname "*.mp3" -o -iname "*.wav" -o -iname "*.flac" \) | head -n 1)
          if [ -z "$INPUT_FILE" ]; then
            echo "ERROR: No supported audio file (.mp3, .wav, .flac) found in 'raw_audio/' directory."
            exit 1
          fi
          echo "Processing file: $INPUT_FILE"

          # ä½¿ç”¨ Demucs è¿›è¡Œåˆ†ç¦»
          python -m demucs.separate -n mdx_q --two-stems=vocals -o ./separated "$INPUT_FILE"

          # éªŒè¯è¾“å‡ºç›®å½•
          MODEL_OUT_DIR="./separated/mdx_q"
          if [ -d "$MODEL_OUT_DIR" ]; then
            SONG_DIR=$(find "$MODEL_OUT_DIR" -maxdepth 1 -type d ! -path "$MODEL_OUT_DIR" | head -n 1)
            if [ -n "$SONG_DIR" ]; then
              echo "Separation successful. Files in: $SONG_DIR"
              echo "song_dir=$SONG_DIR" >> $GITHUB_OUTPUT
            else
              echo "ERROR: Could not find song subdirectory in model output."
              exit 1
            fi
          else
            echo "ERROR: Model output directory '$MODEL_OUT_DIR' was not created."
            exit 1
          fi

      # ç¬¬å››æ­¥ï¼šè½¬æ¢ä¸ºOGGæ ¼å¼
      - name: Convert to OGG
        run: |
          SONG_DIR="${{ steps.separate.outputs.song_dir }}"
          echo "Converting files from: $SONG_DIR"

          # è½¬æ¢ä¼´å¥è½¨ (other.wav -> Inst.ogg)
          if [ -f "$SONG_DIR/other.wav" ]; then
            ffmpeg -i "$SONG_DIR/other.wav" -c:a libvorbis -q:a 6 "Inst.ogg" -y -hide_banner -loglevel error
            echo "âœ… Generated Inst.ogg (Instrumental)"
          else
            echo "ERROR: Could not find 'other.wav' (instrumental track)."
            exit 1
          fi

          # è½¬æ¢äººå£°è½¨ (vocals.wav -> Voices.ogg)
          if [ -f "$SONG_DIR/vocals.wav" ]; then
            ffmpeg -i "$SONG_DIR/vocals.wav" -c:a libvorbis -q:a 6 "Voices.ogg" -y -hide_banner -loglevel error
            echo "âœ… Generated Voices.ogg (Vocals)"
          else
            echo "ERROR: Could not find 'vocals.wav' (vocal track)."
            exit 1
          fi

      # ç¬¬äº”æ­¥ï¼šæ‰“åŒ…å’Œä¸Šä¼ ç»“æœ
      - name: Package Results
        run: |
          zip -j fnf_audio_output.zip Inst.ogg Voices.ogg
          echo "Created fnf_audio_output.zip"

      - name: Upload Audio Artifact
        uses: actions/upload-artifact@v4
        with:
          name: FNF-Audio-Pack
          path: fnf_audio_output.zip
          if-no-files-found: error

      # ç¬¬å…­æ­¥ï¼šå®Œæˆæç¤º
      - name: Completion Notice
        run: |
          echo "ğŸ‰ Audio processing completed successfully!"
          echo "Download the 'FNF-Audio-Pack.zip' from the 'Artifacts' section."
          echo "It contains 'Inst.ogg' and 'Voices.ogg' ready for your Psych Engine mod."
